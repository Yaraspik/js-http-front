(()=>{"use strict";const e=document.querySelector(".loader"),t=async(t={})=>{e.show();const n=await fetch("http://localhost:3000"+t.query,{method:t.method,body:t.body});if(n.ok){const t=await n.json().catch((()=>null));return e.close(),t}return console.log(`Ошибка HTTP: ${n.status}`),e.close(),!1};class n{static async list(e){e(await t({query:"?method=allTickets",method:"GET"}))}static async get(e,n){const i=`?method=ticketById&id=${encodeURIComponent(e)}`;n(await t({query:i,method:"GET"}))}static async create(e,n){const i=JSON.stringify(e);n(await t({query:"?method=createTicket",method:"POST",body:i}))}static async update(e,n,i){const c=encodeURIComponent(e),o=JSON.stringify(n),a=`?method=updateById&id=${c}`;i(await t({query:a,method:"POST",body:o}))}static async delete(e,n){const i=`?method=deleteById&id=${encodeURIComponent(e)}`;n(await t({query:i,method:"GET"}))}}class i{static createTicketElement(e){const t=i.createHTMLElement("div","ticket-body");t.dataset.id=e.id;const n=i.createHTMLElement("input","ticket-round-element");n.setAttribute("type","checkbox"),!0===e.status&&(n.checked=!0);const c=i.createHTMLElement("div","ticket-texts"),o=i.createHTMLElement("span","ticket-text-content",e.name),a=i.createHTMLElement("span",["ticket-text-content","ticket-text-content-description","hide"],e.description),r=i.createHTMLElement("span","ticket-created",i.dateFormatter(e.created)),d=i.createHTMLElement("button","ticket-edit"),s=i.createHTMLElement("button","ticket-remove");return c.append(o,a),t.append(n,c,r,d,s),{body:t,edit:d,remove:s,round:n,description:a}}static createDeleteElModal(e){const t=i.createHTMLElement("div","modal-body"),n=i.createHTMLElement("span","modal-title",e),c=i.createHTMLElement("span","delete-alert","Вы уверены, что хотите удалить тикет? Это действие необратимо"),o=i.createHTMLElement("div","modal-form-buttons"),a=i.createHTMLElement("button",["modal-form-button-cancel","btn"],"Cancel"),r=i.createHTMLElement("button",["modal-form-button-ok","btn"],"OK");return o.append(r,a),t.append(n,c,o),document.body.append(t),{body:t,btnCancel:a,btnOk:r}}static createModal(e,t={}){const n=i.createHTMLElement("div","modal-body"),c=i.createHTMLElement("span","modal-title",e),o=i.createHTMLElement("form","modal-form"),a=i.createLabelElement("Краткое описание","name","input",t.name),r=i.createLabelElement("Подробное описание","description","textarea",t.description),d=i.createHTMLElement("div","modal-form-buttons"),s=i.createHTMLElement("button",["modal-form-button-cancel","btn"],"Cancel"),l=i.createHTMLElement("button",["modal-form-button-ok","btn"],"OK");return d.append(l,s),o.append(a,r,d),n.append(c,o),document.body.append(n),{body:n,form:o,btnCancel:s,btnOk:l}}static createHTMLElement(e,t,n){const i=document.createElement(e);return Array.isArray(t)?t.forEach((e=>{i.classList.add(e)})):i.classList.add(t),n&&"input"!==e&&"textarea"!==e?i.innerText=n:i.value=n,i}static createLabelElement(e,t,n,c=""){const o=i.createHTMLElement("label",["modal-form","modal-form-description-container"]),a=i.createHTMLElement("span",["modal-form","modal-form-description-title"],e),r=i.createHTMLElement(n,"modal-form-description",c);return r.setAttribute("name",t),o.append(a,r),o}static dateFormatter(e){const t=new Date(e),n=t.getHours();let i=t.getMinutes(),c=t.getDate(),o=t.getMonth()+1;return i=i<10?`0${i}`:i,c=c<10?`0${c}`:c,o=o<10?`0${o}`:o,`${c}.${o}.${t.getFullYear()} ${n}:${i}`}}class c{constructor(e){this.ticketList=e,this.editedTicketElement=null}createTicket(e){const t=i.createTicketElement(e);t.body.addEventListener("click",(i=>{if(i.preventDefault(),i.target===t.edit)return this.editedTicketElement=i.target.closest(".ticket-body"),void n.get(e.id,(e=>this.showModalEditTicket(e)));if(i.target===t.remove)return this.editedTicketElement=i.target.closest(".ticket-body"),void this.showModaDeleteTicket();if(i.target!==t.round)t.description.textContent&&t.description.classList.toggle("hide");else{const t=i.target.checked;this.editedTicketElement=i.target.closest(".ticket-body");const c=this.editedTicketElement.dataset.id;n.update(c,{status:t},(t=>{const n=t.find((t=>t.id===e.id));this.redrawUpdatedTicket(n)}))}})),this.ticketList.append(t.body)}drawPrimaryList(e){if(!Array.isArray(e))throw new Error("Список задач не загружен");[...this.ticketList.children].forEach((e=>e.remove())),e.forEach((e=>this.createTicket(e)))}showModaDeleteTicket(){const e=i.createDeleteElModal("Удалить тикет");e.btnCancel.addEventListener("click",(t=>{t.preventDefault(),e.body.remove()})),e.btnOk.addEventListener("click",(t=>{t.preventDefault(),n.delete(this.editedTicketElement.dataset.id,(()=>{this.editedTicketElement.remove(),this.editedTicketElement=null})),e.body.remove()}))}showModalEditTicket(e){const t=i.createModal("Изменить тикет",e);t.btnCancel.addEventListener("click",(e=>{e.preventDefault(),t.body.remove()})),t.btnOk.addEventListener("click",(i=>{i.preventDefault();const c=new FormData(t.form).entries(),o={};for(const e of c){const t=e[0],n=e[1];o[t]=n}n.update(e.id,o,(t=>{const n=t.find((t=>t.id===e.id));this.redrawUpdatedTicket(n)})),t.body.remove()}))}redrawUpdatedTicket(e){this.editedTicketElement.querySelector(".ticket-text-content").innerText=e.name,this.editedTicketElement.querySelector(".ticket-text-content-description").innerText=e.description,this.editedTicketElement.querySelector(".ticket-round-element").checked=e.status,this.editedTicketElement=null}}class o{constructor(e){this.ticketView=e}createModal(){const e=i.createModal("Создать тикет");e.btnCancel.addEventListener("click",(t=>{t.preventDefault(),e.body.remove()})),e.btnOk.addEventListener("click",(t=>{t.preventDefault();const i=new FormData(e.form),c={};for(const e of i.entries()){const t=e[0],n=e[1];c[t]=n}n.create(c,(e=>this.ticketView.createTicket(e))),e.body.remove()}))}}const a=document.getElementById("root");new class{constructor(e){if(!(e instanceof HTMLElement))throw new Error("This is not HTML element!");this.container=e,this.ticketList=this.container.querySelector(".ticket-list"),this.btnAddTicket=this.container.querySelector(".ticket-add-btn"),this.btnEditTicket=this.container.querySelector(".ticket-edit"),this.loader=this.container.querySelector(".loader"),this.ticketView=new c(this.ticketList),this.ticketForm=new o(this.ticketView),this.openModal=this.openModal.bind(this)}init(){n.list((e=>this.ticketView.drawPrimaryList(e))),this.btnAddTicket.addEventListener("click",this.openModal)}openModal(){this.ticketForm.createModal()}}(a).init()})();